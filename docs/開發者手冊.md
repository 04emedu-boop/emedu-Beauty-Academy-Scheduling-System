# 美業教室排課系統 - 開發者技術手冊 (v1.0)

本手冊旨在協助開發者理解系統架構、資料流程與核心邏輯，以便進行後續維護、功能擴充或二次開發。

---

## 目錄
1.  [系統架構概觀](#1-系統架構概觀)
2.  [專案目錄結構](#2-專案目錄結構)
3.  [核心業務邏輯解析](#3-核心業務邏輯解析)
4.  [資料庫 (Google Sheet) 設計規範](#4-資料庫-google-sheet-設計規範)
5.  [功能擴充指南](#5-功能擴充指南)
6.  [開發環境建置](#6-開發環境建置)

---

## 1. 系統架構概觀

本系統採用 **前後端分離** 架構，雖然部署上較為特殊 (後端為 GAS)，但邏輯上是解耦的。

*   **前端 (Frontend)**：
    *   **技術棧**：React (v18), TypeScript, Vite, Tailwind CSS。
    *   **職責**：UI 呈現、狀態管理、表單驗證、與 GAS API 通訊。
    *   **部署**：靜態網頁 (可部署於 Vercel, GitHub Pages, 或本機執行)。

*   **後端 (Backend)**：
    *   **技術**：Google Apps Script (GAS)。
    *   **職責**：接收前端請求 (`doGet`/`doPost`)、驗證邏輯、操作 Google Sheet。
    *   **部署**：以 Web App 形式發布，提供 API Endpoint。

*   **資料庫 (Database)**：
    *   **介質**：Google Sheets。
    *   **結構**：多檔案架構 (不同地區使用不同 Spreadsheet 檔案)。

### 資料流 (Data Flow)
1.  **Read (讀取)**：前端 `App.tsx` -> `gasService.ts (GET)` -> GAS `doGet` -> `getDaySchedule` -> 讀取 Sheet -> 回傳 JSON。
2.  **Write (寫入)**：前端 `App.tsx` -> `gasService.ts (POST)` -> GAS `doPost` -> `submitBooking` -> `writeToMainSchedule` -> 寫入 Sheet -> 回傳結果。

---

## 2. 專案目錄結構

```text
/
├── src/
│   ├── App.tsx             # 主應用程式入口 (包含主要狀態管理與 UI 佈局)
│   ├── components/         # UI 元件
│   │   ├── BookingGrid.tsx # 時間方格顯示 (處理 AVAILABLE/OCCUPIED 狀態)
│   │   ├── Header.tsx      # 頂部導航列 (包含後台連結)
│   │   ├── InputModal.tsx  # 新增老師/課程內容的對話框
│   │   └── SubjectSelector.tsx # 科目選擇器 (支援不同地區不同科目)
│   ├── services/
│   │   ├── gasService.ts   # 真實 GAS API 通訊服務 (Fetch 邏輯)
│   │   └── mockGasService.ts # 模擬資料服務 (開發用，無須連網)
│   ├── utils/
│   │   └── timeUtils.ts    # 時間處理工具 (產生時段、判斷公休日)
│   ├── constants.ts        # 全域常數 (時段定義、科目順序、API 設定)
│   └── types.ts            # TypeScript 型別定義
├── docs/
│   ├── Code.gs             # Google Apps Script 後端原始碼 (部署用)
│   └── 使用手冊.md          # 終端使用者說明與部署教學
└── package.json            # 專案依賴設定
```

---

## 3. 核心業務邏輯解析

### 3.1 多地區支援 (Multi-Location Support)
*   **前端**：
    *   傳遞 `location` 參數給所有 API 呼叫 (`gasService.ts`)。
    *   `constants.ts` 定義了 `SUBJECT_ORDER_MAP`，讓台北伊美顯示 "SPA" 而非 "實習"。
*   **後端 (`Code.gs`)**：
    *   使用 `SHEET_IDS` 物件儲存不同地區的 Spreadsheet ID。
    *   `getSS(location)` 函式負責根據傳入的 location 切換使用中的 Spreadsheet。

### 3.2 智慧型寫入定位 (Smart Search)
為避免因 Excel 欄位微調導致程式崩潰，後端寫入邏輯 (`writeToMainSchedule`) 採用 **相對定位**而非絕對座標：
1.  **找日期**：搜尋 "X月X日" 字串定位該日區塊的 `(row, col)`。
2.  **找科目**：從日期儲存格往右搜尋 Header (如 "彩妝") 計算 `subjectOffset`。
3.  **找時段**：從日期儲存格往下搜尋時段 (如 "10:00-11:00") 計算 `timeOffset`。
4.  **寫入**：`TargetCell = (StartRow + timeOffset, StartCol + subjectOffset)`。

### 3.3 狀態判斷 (Occupancy Check)
*   後端 `checkOccupancy` 也使用上述定位邏輯讀取儲存格。
*   若儲存格有內容，回傳 `OCCUPIED`，前端 `BookingGrid` 顯示灰色。
*   若儲存格為空，回傳 `AVAILABLE`，前端顯示綠色。

---

## 4. 資料庫 (Google Sheet) 設計規範

每個地區的 Google Sheet 應遵循以下結構：
*   **分頁 (Sheet)**：以民國年/月命名，例如 `115/1`。
*   **區塊設計**：
    *   資料以「日」為單位垂直排列。
    *   每個區塊左上角為日期 (例如 "1月2日")。
    *   第一列為科目 Header (學科, 彩妝, 造型...)。
    *   第一欄為時段 (10:00-11:00...)。

> **注意**：台北伊美的表格 Header 必須包含 "SPA" 才能正確寫入。

---

## 5. 功能擴充指南

### 如何新增一個新的地區？
1.  **取得 ID**：建立新的 Google Sheet，複製其 ID。
2.  **修改後端**：在 `Code.gs` 的 `SHEET_IDS` 中加入新地區與 ID。
3.  **修改前端**：在 `types.ts` 的 `Location` enum 加入新地區，並在 `constants.ts` 的 `LOCATIONS` 陣列中加入。
4.  **重新部署 GAS**：發布新版本。

### 如何修改時段 (例如新增早場)？
1.  **修改前端**：在 `constants.ts` 的 `TIME_SLOTS_WEEKDAY` 陣列中加入新時段字串。
2.  **修改後端**：在 `Code.gs` 的 `getDaySchedule` 函式中同步更新 `slots` 陣列。
3.  **修改 Excel**：確保 Google Sheet 上的時段欄位也有對應的新時段文字，否則會寫入失敗 (找不到時段)。

### 如何新增預約欄位 (例如：學生電話)？
1.  **前端 UI**：在 `App.tsx` 新增 Input 欄位與對應 State。
2.  **API 請求**：修改 `types.ts` 的 `BookingRequest` 介面，與 `gasService.ts` 的傳遞參數。
3.  **後端處理**：修改 `Code.gs` 的 `submitBooking` 與 `writeToMainSchedule`，決定要將電話寫入 Excel 的哪個位置 (或合併在姓名欄位中)。

---

## 6. 開發環境建置

```bash
# Clone 專案
git clone <repository-url>

# 安裝依賴
npm install

# 啟動開發伺服器
npm run dev

# 建置生產版本
npm run build
```

---

**技術支援**：本專案由 Antigravity Agent 協助開發。如有並發問題或邏輯錯誤，請參考 `task.md` 與 `walkthrough.md` 追蹤變更紀錄。
